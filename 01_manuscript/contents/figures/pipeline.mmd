
flowchart TD
    Start([User runs ./compile_manuscript]) --> CheckFiles[Check caption_and_media/ for Figure_ID_*.files]

    CheckFiles --> InputFiles{File Types Found}

    %% Input file types
    InputFiles -->|.mmd| MMD[Mermaid Diagrams]
    InputFiles -->|.pptx| PPTX[PowerPoint Files]
    InputFiles -->|.tif/.tiff| TIF[TIFF Images]
    InputFiles -->|.png| PNG[PNG Images]
    InputFiles -->|.svg| SVG[Vector Graphics]
    InputFiles -->|.jpg/.jpeg| JPG[JPEG Images]

    %% Processing flows
    MMD --> MmdToPng[mmdc: .mmd → .png]
    MmdToPng --> PngToJpg[magick: .png → .jpg]

    PPTX --> PptxToTif[pptx2tif.py: .pptx → .tif]
    PptxToTif --> TifToJpg[magick: .tif → .jpg]

    TIF --> TifToJpg
    PNG --> PngToJpg
    SVG --> SvgToJpg[magick: .svg → .jpg]

    JPG --> NormalizeJpg[Normalize .jpeg → .jpg]
    NormalizeJpg --> CopyJpg[Copy to jpg_for_compilation/]

    %% All converters lead to compilation directory
    PngToJpg --> CompDir[jpg_for_compilation/]
    TifToJpg --> CompDir
    SvgToJpg --> CompDir
    CopyJpg --> CompDir

    %% Caption processing
    CheckFiles --> Captions[Check for .tex caption files]
    Captions --> CreateMissing[Create missing .tex from template]
    CreateMissing --> CompileFigs[Compile LaTeX figures]

    CompDir --> CompileFigs
    CompileFigs --> CompiledDir[compiled/FINAL.tex]
    CompiledDir --> ManuscriptPDF[Final manuscript.pdf]

    %% Directory structure
    subgraph Directories["Directory Structure"]
        CaptionMedia["caption_and_media/<br/>• Source files<br/>• .tex captions"]
        JpgComp["jpg_for_compilation/<br/>• Normalized JPGs<br/>• Auto-generated"]
        Compiled["compiled/<br/>• LaTeX files<br/>• FINAL.tex"]
        Templates["templates/<br/>• .pptx, .tif, .jnt<br/>• Templates"]
    end

    %% Styling
    classDef inputFile fill:#e1f5fe
    classDef process fill:#f3e5f5
    classDef output fill:#e8f5e8
    classDef directory fill:#fff3e0

    class MMD,PPTX,TIF,PNG,SVG,JPG inputFile
    class MmdToPng,PptxToTif,TifToJpg,PngToJpg,SvgToJpg,NormalizeJpg process
    class CompDir,CompiledDir,ManuscriptPDF output
    class CaptionMedia,JpgComp,Compiled,Templates directory
